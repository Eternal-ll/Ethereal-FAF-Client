<UserControl x:Class="beta.Views.ChatView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:local="clr-namespace:beta.Views"
             xmlns:sModels="clr-namespace:beta.Models.Server"
             xmlns:behavior="clr-namespace:beta.Infrastructure.Behaviors"
             xmlns:controls="clr-namespace:beta.Resources.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance local:ChatView}">
    <Grid>
        <Grid.Resources>
            <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="Transparent"/>

            <Style TargetType="TextBlock" x:Key="TextBlockStyle">
                <Setter Property="FontWeight" Value="DemiBold"/>
                <Style.Triggers>
                    <DataTrigger Binding="{Binding Key}" Value="global">
                        <Setter Property="Width" Value="30"/>
                        <Setter Property="Background">
                            <Setter.Value>
                                <VisualBrush Stretch="Uniform">
                                    <VisualBrush.Visual>
                                        <Path ToolTip="Global"
                                              Fill="White"
                                              Data="M39.3,49.1c-2,5.8-3.2,12-3.6,18.5h17.2V49.1H39.3L39.3,49.1z M42.4,41.6h10.5V26.8C48.7,31,45.2,36,42.4,41.6L42.4,41.6z
                                              M34.2,41.6c2.2-5.1,5-9.9,8.3-14.2c-8.5,2.7-15.8,7.8-21.1,14.2H34.2L34.2,41.6z M97,49.1l-15.2,0c1.8,5.8,2.9,12,3.2,18.5h17.6
                                              C102.1,60.9,100.1,54.7,97,49.1L97,49.1z M77.5,67.6c-0.3-6.5-1.6-12.7-3.6-18.5H60.3v18.5H77.5L77.5,67.6z M70.8,41.6
                                              C68.1,36,64.5,31,60.3,26.8v14.8H70.8L70.8,41.6z M79,41.6h12.8c-5.4-6.3-12.7-11.5-21.1-14.2C74,31.7,76.8,36.5,79,41.6L79,41.6z
                                              M16.2,93.6l15.2,0c-1.8-5.8-2.9-12-3.2-18.5H10.6C11.2,81.8,13.1,88.1,16.2,93.6L16.2,93.6z M35.7,75.1c0.3,6.5,1.6,12.7,3.6,18.5
                                              h13.6V75.1H35.7L35.7,75.1z M42.4,101.1c2.8,5.6,6.4,10.6,10.5,14.8v-14.8H42.4L42.4,101.1z M34.2,101.1H21.3
                                              c5.4,6.3,12.7,11.5,21.1,14.2C39.2,111.1,36.4,106.3,34.2,101.1L34.2,101.1z M81.8,93.6l15.2,0c3.1-5.6,5-11.8,5.6-18.5H85
                                              C84.7,81.6,83.6,87.8,81.8,93.6L81.8,93.6z M73.9,93.6c2-5.8,3.2-12,3.6-18.5H60.3v18.5H73.9L73.9,93.6z M70.8,101.1H60.3v14.8
                                              C64.5,111.8,68.1,106.8,70.8,101.1L70.8,101.1z M79,101.1c-2.2,5.1-5,9.9-8.3,14.2c8.5-2.7,15.8-7.8,21.1-14.2H79L79,101.1z
                                              M31.4,49.1l-15.2,0c-3.1,5.6-5,11.9-5.6,18.5h17.6C28.6,61.2,29.7,54.9,31.4,49.1L31.4,49.1z M56.6,125C27,125,3,101,3,71.4
                                              c0-29.6,24-53.6,53.6-53.6c29.6,0,53.6,24,53.6,53.6C110.2,101,86.2,125,56.6,125L56.6,125z"/>
                                    </VisualBrush.Visual>
                                </VisualBrush>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Key}" Value="ladder_1v1">
                        <Setter Property="Text" Value="1 vs 1"/>
                        <Setter Property="ToolTip" Value="Ladder 1 vs 1"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Key}" Value="tmm_2v2">
                        <Setter Property="Text" Value="2 vs 2"/>
                        <Setter Property="ToolTip" Value="TMM 2 vs 2"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Key}" Value="tmm_4v4_full_share">
                        <Setter Property="Text" Value="4 vs 4"/>
                        <Setter Property="ToolTip" Value="TMM 4 vs 4 full share"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Key}" Value="tmm_4v4_share_until_death">
                        <Setter Property="Text" Value="4 vs 4"/>
                        <Setter Property="ToolTip" Value="TMM 4 vs 4 share until death"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

            <Style TargetType="Run" x:Key="RatingDifferenceRunStyle">
                <Setter Property="Text" Value="↓"/>
                <Setter Property="Foreground" Value="Red"/>
                <Setter Property="ToolTip" Value="{Binding DisplayedRatingDifference}"/>
                <Style.Triggers>
                    <DataTrigger Binding="{Binding DisplayedRatingDifference}"
                                 Value="0">
                        <Setter Property="Text" Value="{x:Null}"/>
                        <Setter Property="ToolTip" Value="{x:Null}"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding DisplayedRatingDifference, Converter={StaticResource MoreThanConverter}}"
                        Value="True">
                        <Setter Property="Text" Value="↑"/>
                        <Setter Property="Foreground" Value="Lime"/>
                        <Setter Property="ToolTip" Value="{Binding DisplayedRatingDifference, StringFormat='+{0}'}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

            <DataTemplate DataType="{x:Type sModels:PlayerInfoMessage}">
                <StackPanel MaxWidth="200"
                            Margin="0 0 0 10">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="DataContext" Value="{Binding Converter={StaticResource GetPlayerInfoConverter}}"/>
                        </Style>
                    </StackPanel.Style>
                    <Grid>
                        <Grid.Background>
                            <SolidColorBrush Color="Black" Opacity=".2"/>
                        </Grid.Background>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"
                                              MinWidth="40"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Image
                            VerticalAlignment="Top"
                            Source="{Binding Flag}"
                            HorizontalAlignment="Left"
                            Stretch="Fill"
                            Opacity=".5"
                            MaxHeight="55"
                            MaxWidth="80"
                            Margin="-10 -6 -20 -10"
                            ToolTip="{Binding country}">
                            <Image.OpacityMask>
                                <LinearGradientBrush StartPoint="0 .5" EndPoint="1 .5">
                                    <GradientStop Color="White" Offset=".1"/>
                                    <GradientStop Color="Transparent" Offset=".7"/>
                                </LinearGradientBrush>
                            </Image.OpacityMask>
                        </Image>
                        <Image
                            Margin="10 0 10 0"
                            Stretch="Uniform"
                            MaxWidth="40"
                            MaxHeight="40"
                            HorizontalAlignment="Center">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- TODO: FIX ME / Binding error
                                        Cannot convert '<null>' from type '<null>' to type 'System.Windows.Media.ImageSource'
                                        for 'en-US' culture with default conversions; consider using Converter property of Binding.
                                        NotSupportedException:'System.NotSupportedException: ImageSourceConverter cannot convert from (null).			
                                        -->
                                        <DataTrigger Binding="{Binding avatar.url, Converter={StaticResource IsNullConverter}}"
                                                     Value="False">
                                            <Setter Property="ToolTip" Value="{Binding avatar.tooltip}"/>
                                            <Setter Property="Source" Value="{Binding avatar.url}"/>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                        <TextBlock
                            Grid.Column="1"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Right"
                            Margin="0 0 14 3"
                            FontWeight="DemiBold"
                            TextWrapping="Wrap">
                            <TextBlock.ContextMenu>
                                <ContextMenu>
                                    <MenuItem
                                        Command="{StaticResource CopyCommand}"
                                        CommandParameter="{Binding login}"
                                        Header="Copy">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Copy"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </TextBlock.ContextMenu>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text">
                                        <Setter.Value>
                                            <MultiBinding StringFormat="[{0}] {1}">
                                                <Binding Path="clan"/>
                                                <Binding Path="login"/>
                                            </MultiBinding>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding clan}"
                                                     Value="{x:Null}">
                                            <Setter Property="Text" Value="{Binding login}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                    
                    <TextBlock
                        Text="Game status"
                        FontWeight="DemiBold"
                        FontSize="14"
                        Margin="10 10 10 4">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                        Value="0">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBlock Padding="24 0 0 0"
                               Margin="10 0">
                        <TextBlock.Background>
                            <VisualBrush Stretch="None" AlignmentX="Left">
                                <VisualBrush.Visual>
                                    <Image Source="{Binding GameStatusImage}">
                                    </Image>
                                </VisualBrush.Visual>
                            </VisualBrush>
                        </TextBlock.Background>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                            Value="0">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                            Value="1">
                                        <Setter Property="Text" Value="In lobby"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                            Value="2">
                                        <Setter Property="Text" Value="Playing live"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                            Value="4">
                                        <Setter Property="Text" Value="Hosting"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding GameState}"
                                                                            Value="9">
                                        <Setter Property="Text" Value="Playing"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <TextBlock x:Name="NoteTitle"
                               Text="Note"
                               FontWeight="DemiBold"
                               FontSize="14"
                               Margin="10 8 10 2"/>
                    <TextBox ui:ControlHelper.PlaceholderText="Click to add a note"
                             TextWrapping="Wrap"
                             Padding="6 2"
                             MinHeight="0"
                             Margin="6 0"
                             FontSize="13"
                             Text="{Binding Note}">
                        <TextBox.Resources>
                            <SolidColorBrush x:Key="TextControlBackgroundPointerOver" Color="Transparent"/>
                            <Thickness x:Key="TextControlBorderThemeThicknessFocused">0</Thickness>
                        </TextBox.Resources>
                        <TextBox.Style>
                            <Style TargetType="TextBox" BasedOn="{StaticResource DefaultTextBoxStyle}">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="Green"/>
                                <Setter Property="ToolTip" Value="Click to edit note"/>
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="ToolTip" Value="Click to add note"/>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>

                    <TextBlock Text="Ratings" FontWeight="DemiBold" FontSize="14" Visibility="Collapsed"/>
                    <!--
                    Children[6]
                    -->
                    <StackPanel
                        Margin="10 10 10 0"
                        Orientation="Horizontal">
                        <StackPanel.Resources>
                            <Style TargetType="Button" BasedOn="{StaticResource DefaultButtonStyle}">
                                <Setter Property="Width" Value="24"/>
                                <Setter Property="Height" Value="24"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="HorizontalAlignment" Value="Left"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Setter Property="Background" Value="DimGray"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self},Path=Parent.Children[0].IsChecked}"
                                                 Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Resources>
                        <ToggleButton
                            Padding="6 0 6 2"
                            Content="Ratings">
                            <ToggleButton.Style>
                                <Style TargetType="ToggleButton" BasedOn="{StaticResource DefaultToggleButtonStyle}">
                                    <Setter Property="Content" Value="Show ratings"/>
                                    <Setter Property="Opacity" Value=".9"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsChecked"
                                             Value="True">
                                            <Setter Property="Opacity" Value="1"/>
                                            <Setter Property="Content" Value="Hide ratings"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ToggleButton.Style>
                        </ToggleButton>
                        <Button
                            Content="R"
                            ToolTip="Rating"
                            Margin="14 0 0 0"/>
                        <Button
                            Content="G"
                            ToolTip="Games"
                            Margin="6 0 0 0"/>
                    </StackPanel>

                    <ItemsControl
                        Margin="10 10 0 0"
                        HorizontalAlignment="Stretch"
                        ItemsSource="{Binding ratings, Mode=OneWay}">
                        <ItemsControl.Style>
                            <Style TargetType="ItemsControl">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <!--
                                    TODO FIX ME / Sometimes getting Binding error because children[0] is not a ToggleButton
                                    -->
                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource Self},Path=Parent.Children[6].Children[0].IsChecked}"
                                                 Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ItemsControl.Style>
                        <ItemsControl.ItemTemplate>
                            <ItemContainerTemplate>
                                <Grid Background="Transparent">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="60"/>
                                        <ColumnDefinition Width="90"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock
                                        Margin="0 0 0 0"
                                        HorizontalAlignment="Center"
                                        Style="{StaticResource TextBlockStyle}"/>
                                    <Grid
                                        DataContext="{Binding Value}"
                                        Grid.Column="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock
                                            Grid.Column="0"
                                            Margin="0 0 6 0"
                                            HorizontalAlignment="Right">
                                            <Run Text="{Binding DisplayedRating}"/>
                                            <Run Style="{StaticResource RatingDifferenceRunStyle}"/>
                                        </TextBlock>

                                        <!--<TextBlock Text="{Binding rating[1], StringFormat=' +-{0}', Mode=OneWay}" Grid.Column="2"/>-->
                                        <!--<TextBlock Text="G:" Grid.Column="3" Margin="10 0 10 0" HorizontalAlignment="Right"/>-->
                                        <TextBlock
                                            Text="{Binding number_of_games, Mode=OneWay}"
                                            Grid.Column="1"
                                            HorizontalAlignment="Left"
                                            Margin="0"/>
                                    </Grid>
                                </Grid>
                            </ItemContainerTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <TextBlock Text="{Binding id, StringFormat='id: {0}'}"
                               Visibility="Collapsed"
                                                           Opacity=".3">
                        <TextBlock.ContextMenu>
                            <ContextMenu>
                                <MenuItem Command="{StaticResource CopyCommand}"
                                                                      CommandParameter="{Binding id}"
                                                                      Header="Copy">
                                    <MenuItem.Icon>
                                        <ui:SymbolIcon Symbol="Copy"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </TextBlock.ContextMenu>
                    </TextBlock>
                </StackPanel>
            </DataTemplate>

            <ui:Flyout x:Key="ChatterPlayerCardFlyout" Placement="RightEdgeAlignedTop">
                <ContentControl Content="{Binding}"/>
            </ui:Flyout>

            <ui:Flyout x:Key="MessagePlayerCardFlyout" Placement="RightEdgeAlignedTop">
                <ContentControl Content="{Binding Converter={StaticResource GetPlayerInfoConverter}}"/>
            </ui:Flyout>
            
        </Grid.Resources>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <Grid>
            <Grid.Resources>
                <SolidColorBrush x:Key="ComboBoxBackgroundFocused" Color="#111111"/>
                <SolidColorBrush x:Key="ComboBoxBackgroundPressed" Color="#111111"/>
                <Thickness x:Key="TextControlBorderThemeThicknessFocused">0</Thickness>
            </Grid.Resources>
            <Grid.RowDefinitions>
                <RowDefinition Height="32"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <TextBox
                Visibility="Hidden"
                Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                Text="{Binding SelectedChannel.Name}"
                FontWeight="DemiBold"
                IsTabStop="False"
                IsHitTestVisible="False"
                HorizontalAlignment="Left"
                Padding="20 6 20 10"
                Margin="30 0"
                BorderThickness="0"
                ui:ControlHelper.CornerRadius="6"/>
            <StackPanel Orientation="Horizontal">
                <ui:TitleBarButton 
                    Margin="30 0"
                    HorizontalAlignment="Left"
                    Width="NaN"
                    Padding="0"
                    HorizontalContentAlignment="Left"
                    HoverBackground="Transparent"
                    PressedBackground="Transparent">
                    <StackPanel 
                        Orientation="Horizontal">
                        <ComboBox
                            ItemsSource="{Binding Channels}"
                            SelectedItem="{Binding SelectedChannel}"
                            BorderThickness="0"
                            Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                            DisplayMemberPath="FormattedName"
                            Padding="20 6 20 10"
                            FontWeight="DemiBold"
                            ui:ControlHelper.CornerRadius="6"/>
                        <Button
                            Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                            ToolTip="Join channel"
                            Margin="10 0 0 0"
                            Content=" + "
                            FontWeight="Bold"
                            ui:ControlHelper.CornerRadius="6">
                            <ui:FlyoutService.Flyout>
                                <ui:Flyout Placement="BottomEdgeAlignedLeft">
                                    <StackPanel
                                        Orientation="Vertical"
                                        Margin="-6">
                                        <TextBox
                                            x:Name="JoinChannelInput"
                                            BorderThickness="0"
                                            MinWidth="100"
                                            ui:ControlHelper.CornerRadius="4"
                                            ui:ControlHelper.PlaceholderText="Channel"
                                            KeyDown="JoinChannelInput_KeyDown"/>
                                        <TextBlock
                                            Margin="4 4 4 0"
                                            Opacity=".5"
                                            Text='Press Enter to join'
                                            FontSize="12"/>
                                    </StackPanel>
                                </ui:Flyout>
                            </ui:FlyoutService.Flyout>
                        </Button>
                        <TextBlock Text="{Binding SelectedChannel.Title}"/>
                    </StackPanel>
                </ui:TitleBarButton>
            </StackPanel>
            <ListBox
                ItemsSource="{Binding Channels, Mode=OneWay}"
                SelectedItem="{Binding SelectedChannel}"
                Background="Transparent"
                Padding="20 0"
                Visibility="Hidden"
                Grid.Row="1"
                ScrollViewer.HorizontalScrollBarVisibility="Auto">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.Resources>
                    <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                        <Setter Property="Padding" Value="20 4"/>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Name}"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            <Border
                Margin="0 30"
                Grid.Row="1"
                CornerRadius="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <ListBox
                        ItemsSource="{Binding SelectedChannel.History}"
                        VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling"
                        VirtualizingPanel.IsContainerVirtualizable="True"
                        Background="Transparent">
                        <ListBox.Resources>
                            <SolidColorBrush x:Key="SystemControlHighlightListLowBrush" Color="DimGray" Opacity=".05"/>
                            <ui:Flyout x:Key="EmojiFlyout">
                                <Grid Margin="-10 -10 -10 -4">
                                    <Grid.RowDefinitions>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                    </Grid.RowDefinitions>
                                    <Canvas Background="Black" Opacity=".2"
                                            Margin="-2 -2 -2 -2"/>
                                    <Image
                                        Source="{Binding Source}"
                                        Width="100"
                                        MaxHeight="100"
                                        Margin="0"
                                        Stretch="Uniform">
                                        <Image.Style>
                                            <Style>
                                            </Style>
                                        </Image.Style>
                                    </Image>
                                    <TextBox
                                        Grid.Row="1"
                                        Margin="0 8 0 0"
                                        Opacity=".5"    
                                        BorderThickness="0"
                                        Background="Transparent"
                                        IsReadOnly="True"
                                        Text="{Binding ToolTip, StringFormat=':{0}:'}"/>
                                    <Button
                                        Grid.Row="2"
                                        Style="{StaticResource DefaultButtonStyle}"
                                        Content="Copy"
                                        Command="{StaticResource CopyCommand}"
                                        CommandParameter="{Binding ToolTip, Converter={StaticResource EmojiFormatConverter}}"
                                        HorizontalAlignment="Center"
                                        Padding="10 2 10 4"
                                        Opacity=".7"
                                        Margin="0"
                                        Background="Transparent"/>
                                </Grid>
                            </ui:Flyout>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource DefaultListBoxItemStyle}">
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0"/>
                                <Setter Property="Focusable" Value="False"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="VerticalContentAlignment" Value="Center"/>
                            </Style>
                            <Style TargetType="Image">
                                <Setter Property="MaxHeight" Value="24"/>
                                <Setter Property="ui:ContextFlyoutService.ContextFlyout" Value="{StaticResource EmojiFlyout}"/>
                            </Style>
                            <Style TargetType="controls:GifImage">
                                <Setter Property="ui:ContextFlyoutService.ContextFlyout" Value="{StaticResource EmojiFlyout}"/>
                            </Style>
                            <Style TargetType="Button" BasedOn="{StaticResource DefaultButtonStyle}">
                                <Setter Property="IsTabStop" Value="False"/>
                                <Setter Property="Content" Value="{Binding login}"/>
                                <Setter Property="Padding" Value="6 0 6 2"/>
                                <Setter Property="Margin" Value="4 0 4 0"/>
                                <Setter Property="ui:FlyoutService.Flyout" Value="{DynamicResource MessagePlayerCardFlyout}"/>
                                <Style.Resources>
                                    <Thickness x:Key="FlyoutContentThemePadding">0</Thickness>
                                </Style.Resources>
                            </Style>
                        </ListBox.Resources>
                        <ListBox.ItemTemplate>
                            <ItemContainerTemplate>
                                <Grid Margin="0 0 0 4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width=".25*" MinWidth="100"/>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock
                                        TextWrapping="Wrap"
                                        HorizontalAlignment="Right">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding From}"
                                                                 Value="{x:Null}">
                                                        <Setter Property="Margin" Value="10 0 14 -4"/>
                                                        <Setter Property="VerticalAlignment" Value="Stretch"/>
                                                        <Setter Property="Text" Value=""/>
                                                        <Setter Property="Opacity" Value=".09"/>
                                                        <Setter Property="Width" Value="2"/>
                                                        <Setter Property="Background" Value="Gray"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <Button
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Top"
                                        Background="Transparent">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                                <Setter Property="Content" Value="{Binding From}"/>
                                                <Setter Property="Padding" Value="6 0 6 2"/>
                                                <Setter Property="Margin" Value="0 0 10 0"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding From}"
                                                                 Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <TextBlock
                                        Background="Transparent"
                                        VerticalAlignment="Center"
                                        Grid.Column="1"
                                        Opacity=".8"
                                        behavior:TextBlockExtensions.BindableInlines="{Binding Message, Converter={StaticResource TextConverter}}"
                                        TextWrapping="Wrap">
                                    </TextBlock>
                                    <Canvas
                                        IsHitTestVisible="False"
                                        Grid.ColumnSpan="3"
                                        Margin="0">
                                        <Canvas.Style>
                                            <Style TargetType="Canvas">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasMention}"
                                                                 Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Setter Property="Background">
                                                            <Setter.Value>
                                                                <SolidColorBrush Color="Orange" Opacity=".07"/>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Canvas.Style>
                                        <Canvas
                                            Background="Orange"
                                            Width="2"
                                            Height="{Binding RelativeSource={RelativeSource AncestorType={x:Type Canvas}}, Path=ActualHeight}"/>
                                    </Canvas>
                                    <TextBlock
                                        Margin="0 4 24 0"
                                        Opacity=".09"
                                        Grid.Column="2"
                                        Text="{Binding Created, StringFormat='{}{0:HH:mm}'}"/>
                                </Grid>
                            </ItemContainerTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <TextBox
                        Grid.Row="1"
                        Name="MessageInput"
                        BorderThickness="0"
                        ui:ControlHelper.PlaceholderText="Write message">
                        <TextBox.Resources>
                            <Style x:Key="TextBoxStyle" TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SelectedChannel.Name}"
                                                 Value="#server">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                            <SolidColorBrush x:Key="TextControlBackgroundFocused" Color="#99000000"/>
                        </TextBox.Resources>
                    </TextBox>
                    <Canvas Grid.Row="1"
                            Panel.ZIndex="2"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top">
                        <Border
                            Margin="{Binding Thickness}"
                            Visibility="{Binding VisibilityTest}"
                            Canvas.Left="0"
                            Canvas.Bottom="0"
                            Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                            Padding="0 10"
                            CornerRadius="4">
                            <Border.Effect>
                                <DropShadowEffect
                                    ShadowDepth="4"
                                    BlurRadius="20"
                                    Direction="-90"
                                    Opacity=".4"/>
                            </Border.Effect>
                            <StackPanel>
                                <TextBlock
                                    Text="Suggestions"
                                    HorizontalAlignment="Center"
                                    Opacity=".5"
                                    Margin="0 0 0 10"/>
                                <ListBox
                                    Width="100"
                                    Focusable="False"
                                    Name="SuggestionListBox"
                                    MaxHeight="200"
                                    Background="Transparent">
                                    <ListBox.Resources>
                                        <SolidColorBrush x:Key="SystemControlHighlightListAccentMediumLowBrush" Color="Gray" Opacity=".2"/>
                                        <Style TargetType="ListBoxItem" BasedOn="{StaticResource DefaultListBoxItemStyle}">
                                            <Setter Property="Focusable" Value="False"/>
                                            <Setter Property="Opacity" Value=".6"/>
                                            <Setter Property="Padding" Value="6 2 6 4"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter Property="Opacity" Value="1"/>
                                                    <Setter Property="Background" Value="Transparent"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ListBox.Resources>
                                </ListBox>
                            </StackPanel>
                        </Border>
                    </Canvas>
                </Grid>
            </Border>
        </Grid>
        <Grid 
            Grid.Column="2"
            Margin="2 0 0 0"
            Panel.ZIndex="2"
            Background="{DynamicResource NavigationViewExpandedPaneBackground}">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding SelectedChannel.Users.Count}"
                                     Value="0">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <Grid.RowDefinitions>
                <RowDefinition Height="32"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition/>
            </Grid.RowDefinitions>
            <Grid.Resources>
                <Storyboard x:Key="OpacityAnimationShow">
                    <DoubleAnimation
                    Storyboard.TargetProperty="Opacity" 
                    To="1" 
                    Duration="0:0:0.2"/>
                </Storyboard>
                <Storyboard x:Key="OpacityAnimationHide">
                    <DoubleAnimation
                    Storyboard.TargetProperty="Opacity" 
                    To="0"
                    Duration="0:0:0.2"/>
                </Storyboard>
            </Grid.Resources>
            
            <TextBlock
                Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                Text="Chat users"
                FontWeight="DemiBold"
                Padding="0 6 0  0"
                Margin="18 0 0 0"/>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Button
                    Margin="8 6 0 0"
                    Height="30"
                    Width="30"
                    Background="{DynamicResource NavigationViewExpandedPaneBackground}"
                    Padding="0"
                    ui:ControlHelper.CornerRadius="4"
                    ToolTip="More"
                    VerticalAlignment="Top">
                    <Grid>
                        <Path
                            Margin="6"
                            Stretch="Uniform"
                            Fill="White"
                            Data="M16,12A2,2 0 0,1 18,10A2,2 0 0,1 20,12A2,2 0 0,1 18,14A2,2 0 0,1 16,12M10,12A2,2 0 0,1 12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12M4,12A2,2 0 0,1 6,10A2,2 0 0,1 8,12A2,2 0 0,1 6,14A2,2 0 0,1 4,12Z"
                            />
                        <Canvas
                            Margin="0 -8 0 0"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top">
                            <Canvas
                                Canvas.Right="0"
                                Background="Transparent"
                                Width="20"
                                Height="{Binding ElementName=MoreWindow, Path=ActualHeight}"
                                IsHitTestVisible="{Binding RelativeSource={RelativeSource AncestorType={x:Type Button}},
                                            Path=IsMouseOver}"/>
                            <Border
                                x:Name="MoreWindow"
                                Padding="10"
                                CornerRadius="6"
                                Canvas.Right="13"
                                Background="{StaticResource NavigationViewDefaultPaneBackground}">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Opacity" Value="0"/>
                                        <Style.Triggers>
                                            <Trigger Property="Opacity" Value="0">
                                                <Setter Property="IsHitTestVisible" Value="False"/>
                                            </Trigger>
                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType={x:Type Button}},
                                            Path=IsMouseOver}"
                                                     Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard Storyboard="{StaticResource OpacityAnimationShow}"/>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <BeginStoryboard Storyboard="{StaticResource OpacityAnimationHide}"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Border.Effect>
                                    <DropShadowEffect
                                        Color="#111111"
                                        Opacity=".4"
                                        Direction="-90"
                                        BlurRadius="30"/>
                                </Border.Effect>
                                <StackPanel MinWidth="140">
                                    <TextBlock Text="Filter players" FontWeight="DemiBold" FontSize="14"/>
                                    <Separator Opacity=".5" Margin="0 6 0 10"/>
                                    <ComboBox
                                        FontSize="13"
                                        SelectedIndex="0"
                                        ui:ControlHelper.Header="Chat users"
                                        HorizontalAlignment="Stretch"
                                        BorderThickness="0">
                                        <ComboBoxItem Content="All"/>
                                        <ComboBoxItem Content="Players only"/>
                                    </ComboBox>


                                    <TextBlock Text="Sort players" FontWeight="DemiBold" FontSize="14" Margin="0 20 0 0"/>
                                    <Separator Opacity=".5" Margin="0 6 0 10"/>
                                    <ComboBox
                                        FontSize="13"
                                        SelectedIndex="0"
                                        ui:ControlHelper.Header="By rating"
                                        HorizontalAlignment="Stretch"
                                        BorderThickness="0">
                                        <ComboBoxItem Content="All"/>
                                        <ComboBoxItem Content="Ladder"/>
                                        <ComboBoxItem Content="Global"/>
                                        <ComboBoxItem Content="2 vs 2"/>
                                        <ComboBoxItem Content="4 vs 4"/>
                                    </ComboBox>
                                    <ui:ToggleSwitch
                                        HorizontalAlignment="Stretch"
                                        FontSize="13"
                                        Margin="0 10 0 0"
                                        Header="By TMM league"
                                        ToolTip="Sorting players by their Team Match Making league place"/>
                                </StackPanel>
                            </Border>
                        </Canvas>
                    </Grid>
                </Button>
                <TextBox
                    Grid.Column="1"
                    BorderThickness="0"
                    Margin="9 4 10 10"
                    ui:ControlHelper.CornerRadius="6"
                    ui:ControlHelper.PlaceholderText="Search players"
                    Text="{Binding SelectedChannel.FilterText, UpdateSourceTrigger=PropertyChanged}"/>
            </Grid>
            <ListBox 
                ItemsSource="{Binding SelectedChannel.UsersView}"
                Grid.Row="2"
                SelectedItem="{x:Null}"
                HorizontalContentAlignment="Stretch"
                Background="Transparent"
                VirtualizingPanel.IsVirtualizing="True"
                VirtualizingPanel.VirtualizationMode="Recycling"
                VirtualizingPanel.IsContainerVirtualizable="True">
                <ListBox.Resources>
                    <Style TargetType="ListBoxItem" BasedOn="{StaticResource DefaultListBoxItemStyle}">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Focusable" Value="False"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    </Style>
                </ListBox.Resources>
                <ListBox.ItemTemplate>
                    <ItemContainerTemplate>
                        <Button 
                            Width="NaN"
                            HorizontalAlignment="Stretch"
                            d:DataContext="{d:DesignInstance sModels:PlayerInfoMessage}"
                            ui:FlyoutService.Flyout="{StaticResource ChatterPlayerCardFlyout}">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid d:DataContext="{d:DesignInstance sModels:PlayerInfoMessage}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                            <Image 
                                                    Source="{Binding Flag}"
                                                    Stretch="None"
                                                    ToolTip="{Binding country}"
                                                    Margin="10 0 10 0"/>
                                            <StackPanel Grid.Column="1"
                                                        Orientation="Horizontal">
                                                <TextBlock Text="{Binding login}"
                                                       HorizontalAlignment="Left">
                                                </TextBlock>
                                                <Image Stretch="Uniform" Height="13"
                                                       Margin="4 -10 0 0"
                                                       ToolTip="{Binding Note}">
                                                    <Image.Style>
                                                        <Style TargetType="Image">
                                                            <Setter Property="Source" Value="{StaticResource NoteIcon}"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Note}" Value="{x:Null}">
                                                                    <Setter Property="Source" Value="{x:Null}"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Note}" Value="">
                                                                    <Setter Property="Source" Value="{x:Null}"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Image.Style>
                                                </Image>
                                            </StackPanel>
                                            <Image Source="{Binding GameStatusImage}" Grid.Column="2" Stretch="None"
                                                   HorizontalAlignment="Right"
                                                   Margin="0 0 20 0">
                                            </Image>
                                        </Grid>
                                    </Grid>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </ItemContainerTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            <Canvas
                Grid.Row="2"
                VerticalAlignment="Top"
                Height="40"
                Panel.ZIndex="1"
                SnapsToDevicePixels="True"
                Background="#111111"
                IsHitTestVisible="False">
                <Canvas.OpacityMask>
                    <LinearGradientBrush EndPoint=".5, 0" StartPoint=".5, 1">
                        <GradientStop Color="#00000000" Offset="0"/>
                        <GradientStop Color="Black" Offset=".9"/>
                    </LinearGradientBrush>
                </Canvas.OpacityMask>
                <Canvas.Style>
                    <Style TargetType="Canvas">
                        <Setter Property="Opacity" Value="0"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding ContentVerticalOffset, Converter={StaticResource MoreThanConverter}}"
                                     Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard Storyboard="{StaticResource OpacityAnimationShow}"/>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard Storyboard="{StaticResource OpacityAnimationHide}"/>
                                </DataTrigger.ExitActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Canvas.Style>
            </Canvas>
        </Grid>
        <GridSplitter
            Grid.Column="1"
            Width="2"
            Panel.ZIndex="1"
            HorizontalAlignment="Left"
            ToolTip="Splitter">
            <GridSplitter.Style>
                <Style TargetType="GridSplitter">
                    <Setter Property="Background" Value="Transparent"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding SelectedChannel.Users.Count}"
                                     Value="0">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="BlueViolet"/>
                            <Setter Property="Panel.ZIndex" Value="2"/>
                        </Trigger>
                        <Trigger Property="IsFocused" Value="True">
                            <Setter Property="Background" Value="BlueViolet"/>
                            <Setter Property="Panel.ZIndex" Value="2"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </GridSplitter.Style>
        </GridSplitter>
    </Grid>
</UserControl>
